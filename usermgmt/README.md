# UKMDA User Management

This folder contains the scripts used to add/maintain new cameras to the network. 

## Basic Principles
A camera consists of an RMS ID, location and pointing direction. 

Each _location_ is assigned a unique *AWS* user with credentials that grant suitable permissions to the S3 storage. For example, a contributor in Toytown might be assigned a unique AWS user "Toytown".

AWS credentials are not shared between locations. If a location's credentials are compromised, they can be disabled without impacting the rest of the network and new credentials can then be issued. The *ukmon-pitools* toolset is designed so that new credentials will be picked up the next time *refreshTools.sh* is run on the impacted Pi (either at reboot or manually).

Each _camera_ is allocated a unique *Unix* ID. The public ssh key provided by the operator is used to enable *ukmon-pitools* to login and collect configuration information for the camera. For example if the contributor at Toytown had two cameras facing North and South, the cameras might be named "toytown_s" and "toytown_n". Note that camera names are in lower case, must be unique and that SSH keys should not be shared between cameras. If the operator chooses to share keys they do so at their own risk and it means that if the key is compromised, all their cameras will be unable to connect.  


# User Management tool
Unix and AWS User creation and configuration are managed by *stationMaint.ps1* which calls a python programme that uses native AWS and Unix libraries to execute the required commands. The tool requires AWS and SSH credentials which are restricted to administrators (see note below). 

## Setup
Prerequisites:  
* anaconda or miniconda
* An AWS profile with the usermaintenance IAM role. The default profile name is *ukmda_admin*.
* An SSH key thats permissioned to connect to the server. The default key name is *ukmda_admin*.
 
To install the app, copy the python files, requirements.txt and powershell script to a folder of your choosing, and update the environment variables in the powershell script as needed.  Now run the powershell script which will create a suitable Conda environment, install the requirements and launch the tool. 

## Adding a new camera
To add a new camera the camera operator must supply the following:
* RMS ID (from the RMS .config file)
* town or village (eg Toytown)
* approx pointing direction (eg SW)
* the SSH public key generated by *ukmon-pitools*.  
* Human name and email address of the operator. 

RMS ID, pointing direction and SSH key are unique to each camera. Other values will generally be shared
by other cameras at the same location. 

Once the information has been gathered, select Camera/Add and fill in the boxes. Note that the boxes are part-prepopulated with values from whatever row your cursor was on, so that if you're adding another camera at an existing location, you can save a bit of typing. 

## Amending a camera
The location and pointing direction cannot be changed once set. To change these values you'll need to follow the process to move a camera.  
All other values can be amended by selecting the line and updating the values. 

## Moving a camera
To move a camera to a new location, select the row containing the camera then select Camera/Move. After you fill in any new information, a new unix and AWS user will be created and the configuration files for the old user will be updated. The old camera must then be marked disabled as explained next. 

IMPORTANT NOTE: the camera owner should NOT make any changes - the system will automatically update their configuration.

## Disabling a camera
To disable a camera, change the Active column from 1 to today's date in YYYYMMDD format eg 20220715. This removes the camera from current reporting, but retains the details for any historical reporting. 

# Disabling a location
To disable a location, we revoke the corresponding AWS user's keys, and if necessary, delete the AWS user and Unix ID. No other user will be affected. This is not currently managed by the UI as it is a drastic action that we do not want to carry out accidentally! 

# Permissions Needed
This tool requires two sets of permissions:  
* an AWS profile with permissions to add/amend/delete users in IAM. This is required to manage the AWS roles. 
* an SSH key with permissions to login to the Batch server.  This is required to manage the Unix accounts. 

# Parameters
The powershell script lists the parameters that need to be set, such as AWS profile to use, the buckets and so on. The ansible YAML script sets these values. 


# Copyright
All code Copyright (C) 2018-2023 Mark McIntyre